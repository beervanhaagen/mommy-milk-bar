<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verificatie - Mommy Milk Bar</title>
    <link rel="icon" type="image/png" href="assets/images/MMB_app_icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FAF7F3;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Confetti Animation */
        .confetti {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #F49B9B;
            animation: confetti-fall 3s ease-out forwards;
        }

        .confetti-piece.square {
            width: 8px;
            height: 8px;
        }

        .confetti-piece.circle {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .confetti-piece.ribbon {
            width: 5px;
            height: 12px;
            border-radius: 2px;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(-100px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* Sparkle Animation */
        @keyframes sparkle {
            0%, 100% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .sparkle {
            position: absolute;
            width: 20px;
            height: 20px;
            opacity: 0;
            animation: sparkle 1.5s ease-in-out infinite;
        }

        .sparkle::before,
        .sparkle::after {
            content: '';
            position: absolute;
            background: #F49B9B;
        }

        .sparkle::before {
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        .sparkle::after {
            width: 2px;
            height: 100%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }

        .container {
            max-width: 500px;
            width: 90%;
            background: white;
            border-radius: 24px;
            padding: 48px 32px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(244, 155, 155, 0.15);
            position: relative;
            z-index: 1;
        }

        .mimi-container {
            width: 180px;
            height: 180px;
            margin: 0 auto 24px;
            animation: bounce 0.6s ease-in-out, celebrate 2s ease-in-out 0.6s;
            position: relative;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.1); }
        }

        @keyframes celebrate {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-10deg) scale(1.05); }
            75% { transform: rotate(10deg) scale(1.05); }
        }

        .mimi-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .title {
            font-family: 'Quicksand', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #4B3B36;
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .message {
            font-size: 18px;
            color: #7A6C66;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .status-icon {
            font-size: 64px;
            margin-bottom: 16px;
            display: block;
        }

        /* Loading State */
        .loading {
            display: block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #F49B9B;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success State */
        .success {
            display: none;
        }

        .success.active {
            display: block;
        }

        /* Error State */
        .error {
            display: none;
        }

        .error.active {
            display: block;
        }

        .error .title {
            color: #E47C7C;
        }

        .cta-button {
            display: inline-block;
            padding: 16px 32px;
            background-color: #F49B9B;
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 16px;
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 155, 155, 0.3);
        }

        .secondary-link {
            display: block;
            margin-top: 20px;
            color: #8E8B88;
            font-size: 14px;
            text-decoration: none;
        }

        .secondary-link:hover {
            color: #F49B9B;
            text-decoration: underline;
        }

        /* Hide states initially */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="loading-spinner"></div>
            <h1 class="title">Even geduld...</h1>
            <p class="message">We verifi√´ren je e-mailadres.</p>
        </div>

        <!-- Success State -->
        <div id="successState" class="success">
            <div class="mimi-container">
                <img src="assets/images/landing_page_happy_mimi.png" alt="Mimi blij" class="mimi-img">
            </div>
            <h1 class="title">Gelukt!</h1>
            <p class="message">
                Je e-mailadres is succesvol geverifieerd.<br>
                Welkom bij Mommy Milk Bar!
            </p>
            <a href="index.html" class="cta-button">Ga naar de website</a>
            <a href="mailto:info@mommymilkbar.nl" class="secondary-link">Contact opnemen</a>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error">
            <div class="mimi-container">
                <img src="assets/images/landing_page_sad_mimi.png" alt="Mimi gefrustreerd" class="mimi-img" onerror="this.style.display='none'">
            </div>
            <h1 class="title">‚ö†Ô∏è Oeps...</h1>
            <p class="message" id="errorMessage">
                Er ging iets mis bij het verifi√´ren van je e-mailadres.
            </p>
            <a href="index.html" class="cta-button">Terug naar de website</a>
            <a href="mailto:info@mommymilkbar.nl" class="secondary-link">Hulp nodig? Neem contact op</a>
        </div>
    </div>

    <script type="module">
        // Create confetti
        function createConfetti() {
            const colors = ['#F49B9B', '#FFFFFF', '#E47C7C', '#FDF2F2', '#FFD700', '#FF69B4', '#87CEEB'];
            const shapes = ['square', 'circle', 'ribbon'];

            // Create 100 confetti pieces for a more spectacular effect
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                confetti.className = `confetti-piece ${shape}`;
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.top = '-20px';
                document.body.appendChild(confetti);
            }

            // Add some sparkles around the Mimi
            for (let i = 0; i < 8; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                const angle = (Math.PI * 2 * i) / 8;
                const radius = 100;
                sparkle.style.left = `calc(50% + ${Math.cos(angle) * radius}px)`;
                sparkle.style.top = `calc(30% + ${Math.sin(angle) * radius}px)`;
                sparkle.style.animationDelay = Math.random() * 1 + 's';
                document.body.appendChild(sparkle);
            }
        }

        // Show state
        function showState(state) {
            document.getElementById('loadingState').classList.remove('active');
            document.getElementById('successState').classList.remove('active');
            document.getElementById('errorState').classList.remove('active');

            if (state === 'loading') {
                document.getElementById('loadingState').classList.add('active');
            } else if (state === 'success') {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('successState').classList.add('active');
                createConfetti();
            } else if (state === 'error') {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.add('active');
            }
        }

        // Check if this is a Supabase confirmation callback
        async function handleSupabaseConfirmation() {
            // Supabase uses hash fragments for OAuth/confirmation
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const type = hashParams.get('type');
            const accessToken = hashParams.get('access_token');
            const accountToken = hashParams.get('account_token'); // Also check for account_token
            const error = hashParams.get('error');
            const errorDescription = hashParams.get('error_description');

            // Debug logging
            console.log('üîç Verification Debug:', {
                hash: window.location.hash,
                type,
                accessToken,
                accountToken,
                error,
                errorDescription
            });

            // Check for errors in the URL
            if (error) {
                console.error('Supabase error:', error, errorDescription);
                document.getElementById('errorMessage').textContent =
                    errorDescription || 'Er ging iets mis bij het verifi√´ren van je e-mailadres.';
                showState('error');
                return;
            }

            // Check if this is a signup confirmation (can have either access_token or account_token)
            if (type === 'signup' && (accessToken || accountToken)) {
                console.log('‚úÖ Email verification successful!');
                // Email verification successful!
                showState('success');
                // Clean up the URL hash
                if (window.history.replaceState) {
                    window.history.replaceState(null, '', window.location.pathname);
                }
                return;
            }

            // If no hash params, check for query params (custom token)
            const urlParams = new URLSearchParams(window.location.search);
            const customToken = urlParams.get('token');

            if (customToken) {
                // Custom token verification (for edge function)
                await verifyWithCustomToken(customToken);
                return;
            }

            // No valid verification method found
            document.getElementById('errorMessage').textContent =
                'Geen verificatie gevonden. Gebruik de link uit je e-mail.';
            showState('error');
        }

        // Verify with custom token (edge function)
        async function verifyWithCustomToken(token) {
            try {
                const response = await fetch('https://lqmnkdqyoxytyyxuglhx.supabase.co/functions/v1/verify-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showState('success');
                } else {
                    document.getElementById('errorMessage').textContent =
                        data.message || 'Er ging iets mis. Probeer het opnieuw of neem contact op.';
                    showState('error');
                }
            } catch (error) {
                console.error('Verification error:', error);
                document.getElementById('errorMessage').textContent =
                    'Er is een netwerkfout opgetreden. Controleer je internetverbinding en probeer het opnieuw.';
                showState('error');
            }
        }

        // Start verification on page load
        handleSupabaseConfirmation();
    </script>
</body>
</html>
