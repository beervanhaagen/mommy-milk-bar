<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wachtwoord opnieuw instellen - Mommy Milk Bar</title>
    <link rel="icon" type="image/png" href="assets/images/MMB_app_icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FAF7F3;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .container {
            max-width: 500px;
            width: 90%;
            background: white;
            border-radius: 24px;
            padding: 48px 32px;
            box-shadow: 0 8px 24px rgba(244, 155, 155, 0.15);
            position: relative;
        }

        .mimi-container {
            width: 140px;
            height: 140px;
            margin: 0 auto 24px;
        }

        .mimi-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .title {
            font-family: 'Quicksand', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #4B3B36;
            margin-bottom: 12px;
            text-align: center;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 15px;
            color: #8E8B88;
            margin-bottom: 32px;
            line-height: 1.6;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .label {
            display: block;
            font-weight: 500;
            font-size: 14px;
            color: #4B3B36;
            margin-bottom: 8px;
        }

        .input {
            width: 100%;
            height: 56px;
            background-color: #FFFFFF;
            border-radius: 12px;
            padding: 0 16px;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            color: #4B3B36;
            border: 1px solid #E8E5E1;
            transition: border-color 0.2s;
        }

        .input:focus {
            outline: none;
            border-color: #F49B9B;
        }

        .input::placeholder {
            color: #C4C1BD;
        }

        .submit-button {
            width: 100%;
            height: 56px;
            background-color: #F49B9B;
            color: white;
            border: none;
            border-radius: 38px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 12px;
        }

        .submit-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 155, 155, 0.3);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .back-link {
            display: block;
            margin-top: 20px;
            color: #8E8B88;
            font-size: 14px;
            text-align: center;
            text-decoration: none;
        }

        .back-link:hover {
            color: #F49B9B;
            text-decoration: underline;
        }

        .error-message {
            background-color: #FEE;
            border: 1px solid #FCC;
            color: #C33;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .success-message {
            background-color: #EFE;
            border: 1px solid #CFC;
            color: #3A3;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.3s ease-out;
        }

        .success-checkmark::after {
            content: '‚úì';
            color: white;
            font-size: 48px;
            font-weight: bold;
        }

        @keyframes scaleIn {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .success-info-box {
            background-color: #F5F5F5;
            border-left: 4px solid #4CAF50;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }

        .success-info-box p {
            margin: 8px 0;
            font-size: 14px;
            color: #4B3B36;
            line-height: 1.6;
        }

        .success-info-box .check-item {
            display: flex;
            align-items: flex-start;
            margin: 8px 0;
        }

        .success-info-box .check-item::before {
            content: '‚úì';
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
            font-size: 16px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #F49B9B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .password-requirements {
            font-size: 13px;
            color: #8E8B88;
            margin-top: 8px;
            padding-left: 4px;
        }

        @media only screen and (max-width: 600px) {
            .container {
                padding: 32px 24px;
            }
            .title {
                font-size: 24px;
            }
            .mimi-container {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div class="loading-spinner"></div>
            <p class="subtitle" style="margin-top: 20px;">Even geduld...</p>
        </div>

        <!-- Form State -->
        <div id="formState">
            <div class="mimi-container">
                <img src="assets/images/landing_page_happy_mimi.png" alt="Mimi" class="mimi-img">
            </div>

            <h1 class="title">Nieuw wachtwoord instellen</h1>
            <p class="subtitle">Kies een nieuw wachtwoord voor je Mommy Milk Bar account.</p>

            <div id="errorContainer" class="hidden"></div>

            <form id="resetForm">
                <div class="form-group">
                    <label class="label" for="password">Nieuw wachtwoord</label>
                    <input
                        type="password"
                        id="password"
                        class="input"
                        placeholder="Minimaal 6 tekens"
                        required
                        minlength="6"
                    >
                    <div class="password-requirements">Minimaal 6 tekens</div>
                </div>

                <div class="form-group">
                    <label class="label" for="confirmPassword">Bevestig wachtwoord</label>
                    <input
                        type="password"
                        id="confirmPassword"
                        class="input"
                        placeholder="Herhaal je wachtwoord"
                        required
                        minlength="6"
                    >
                </div>

                <button type="submit" class="submit-button" id="submitButton">
                    Wachtwoord opslaan
                </button>
            </form>

            <a href="index.html" class="back-link">Terug naar website</a>
        </div>

        <!-- Success State -->
        <div id="successState" class="hidden">
            <div class="success-checkmark"></div>

            <h1 class="title">Wachtwoord succesvol bijgewerkt!</h1>
            
            <div class="success-info-box">
                <div class="check-item">
                    <p><strong>Je wachtwoord is gewijzigd</strong><br>
                    Het nieuwe wachtwoord is opgeslagen in je account.</p>
                </div>
                <div class="check-item">
                    <p><strong>Supabase database bijgewerkt</strong><br>
                    Je wachtwoord staat veilig opgeslagen in onze Supabase database en is direct actief.</p>
                </div>
                <div class="check-item">
                    <p><strong>Klaar om in te loggen</strong><br>
                    Je kunt nu direct inloggen in de Mommy Milk Bar app met je nieuwe wachtwoord.</p>
                </div>
            </div>

            <p class="subtitle" style="margin-top: 24px; margin-bottom: 20px;">
                Open de app en log in met je e-mailadres en het nieuwe wachtwoord.
            </p>

            <a href="index.html" class="submit-button" style="display: block; text-align: center; line-height: 56px; text-decoration: none;">
                Terug naar website
            </a>
        </div>

        <!-- Error State (no token) -->
        <div id="errorState" class="hidden">
            <div class="mimi-container">
                <img src="assets/images/landing_page_sad_mimi.png" alt="Mimi gefrustreerd" class="mimi-img" onerror="this.style.display='none'">
            </div>

            <h1 class="title">Ongeldige link</h1>
            <p class="subtitle">
                Deze wachtwoord reset link is niet geldig of verlopen.<br>
                Vraag een nieuwe reset link aan in de app.
            </p>

            <a href="index.html" class="submit-button" style="display: block; text-align: center; line-height: 56px; text-decoration: none;">
                Terug naar website
            </a>
            <a href="mailto:info@mommymilkbar.nl" class="back-link">Hulp nodig? Neem contact op</a>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Initialize Supabase client
        const supabaseUrl = 'https://lqmnkdqyoxytyyxuglhx.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxbW5rZHF5b3h5dHl5eHVnbGh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MDk2MjgsImV4cCI6MjA3OTA4NTYyOH0.pPhA5GZAm0Z22u7KOpiDx0E6hViEETBXkKlDorUgRRo';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        function showState(state) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('formState').classList.add('hidden');
            document.getElementById('successState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');

            if (state === 'loading') {
                document.getElementById('loadingState').classList.remove('hidden');
            } else if (state === 'form') {
                document.getElementById('formState').classList.remove('hidden');
            } else if (state === 'success') {
                document.getElementById('successState').classList.remove('hidden');
            } else if (state === 'error') {
                document.getElementById('errorState').classList.remove('hidden');
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            errorContainer.classList.remove('hidden');
        }

        function hideError() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.classList.add('hidden');
            errorContainer.innerHTML = '';
        }

        // Parse hash parameters
        function getHashParams() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return {
                access_token: params.get('access_token'),
                refresh_token: params.get('refresh_token'),
                type: params.get('type'),
                error: params.get('error'),
                error_description: params.get('error_description')
            };
        }

        // Initialize on page load
        async function initialize() {
            console.log('üöÄ Initializing password reset page...');
            console.log('üìç Current URL:', window.location.href);

            const params = getHashParams();

            console.log('üîç Hash parameters:', {
                type: params.type,
                hasAccessToken: !!params.access_token,
                hasRefreshToken: !!params.refresh_token,
                error: params.error,
                error_description: params.error_description,
                fullHash: window.location.hash
            });

            // Check for errors
            if (params.error) {
                console.error('‚ùå Supabase error:', params.error, params.error_description);
                showState('error');
                return;
            }

            // Check if this is a password recovery
            if (params.type === 'recovery' && params.access_token) {
                console.log('‚úÖ Valid recovery token found');

                // Set the session with the access token
                try {
                    console.log('üîê Setting session with access token...');

                    const { data, error } = await supabase.auth.setSession({
                        access_token: params.access_token,
                        refresh_token: params.refresh_token || ''
                    });

                    console.log('üì• SetSession response:', {
                        hasData: !!data,
                        hasSession: !!data?.session,
                        hasUser: !!data?.user,
                        userEmail: data?.user?.email,
                        hasError: !!error,
                        errorMessage: error?.message,
                        errorStatus: error?.status
                    });

                    if (error) {
                        console.error('‚ùå Session error:', error);
                        showState('error');
                        return;
                    }

                    console.log('‚úÖ Session set successfully for user:', data?.user?.email);
                    showState('form');
                } catch (error) {
                    console.error('üí• Unexpected error during session setup:', error);
                    showState('error');
                }
            } else {
                // No valid recovery token
                console.log('‚ùå No valid recovery token found');
                console.log('Debug info:', {
                    hasType: !!params.type,
                    type: params.type,
                    hasAccessToken: !!params.access_token
                });
                showState('error');
            }
        }

        // Handle form submission
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = document.getElementById('submitButton');

            console.log('üîÑ Form submitted - starting password reset...');

            // Validate passwords match
            if (password !== confirmPassword) {
                console.log('‚ùå Passwords do not match');
                showError('De wachtwoorden komen niet overeen.');
                return;
            }

            // Validate password length
            if (password.length < 6) {
                console.log('‚ùå Password too short');
                showError('Het wachtwoord moet minimaal 6 tekens bevatten.');
                return;
            }

            console.log('‚úÖ Validation passed');

            // Check if we have a valid session first
            const { data: sessionData } = await supabase.auth.getSession();
            console.log('üìã Current session:', {
                hasSession: !!sessionData.session,
                hasAccessToken: !!sessionData.session?.access_token,
                user: sessionData.session?.user?.email
            });

            if (!sessionData.session) {
                console.error('‚ùå No active session found');
                showError('Je sessie is verlopen. Vraag een nieuwe reset link aan.');
                return;
            }

            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.textContent = 'Bezig met opslaan...';

            try {
                console.log('üîê Calling updateUser...');

                // Update the password
                const { data, error } = await supabase.auth.updateUser({
                    password: password
                });

                console.log('üì• UpdateUser response:', {
                    hasData: !!data,
                    hasError: !!error,
                    errorMessage: error?.message,
                    errorStatus: error?.status,
                    userData: data?.user?.email
                });

                if (error) {
                    console.error('‚ùå Update password error:', error);
                    showError(error.message || 'Er ging iets mis bij het bijwerken van je wachtwoord.');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Wachtwoord opslaan';
                    return;
                }

                console.log('‚úÖ Password updated successfully!', data);

                // Verify the update was successful by checking user data
                const { data: userData, error: userError } = await supabase.auth.getUser();

                if (userError) {
                    console.warn('‚ö†Ô∏è Could not verify user after password update:', userError);
                } else {
                    console.log('‚úÖ User verified after password update:', userData.user?.email);
                }

                console.log('üîì Signing out...');
                // Sign out to clear the session (required after password reset)
                await supabase.auth.signOut();

                console.log('‚è±Ô∏è Waiting for database sync...');
                // Small delay to ensure database is synced
                await new Promise(resolve => setTimeout(resolve, 500));

                console.log('üéâ Showing success state');
                // Show success with confirmation
                showState('success');

                // Clean up the URL hash
                if (window.history.replaceState) {
                    window.history.replaceState(null, '', window.location.pathname);
                }
            } catch (error) {
                console.error('üí• Unexpected error:', error);
                showError('Er is een onverwachte fout opgetreden. Probeer het opnieuw.');
                submitButton.disabled = false;
                submitButton.textContent = 'Wachtwoord opslaan';
            }
        });

        // Start initialization
        initialize();
    </script>
</body>
</html>
